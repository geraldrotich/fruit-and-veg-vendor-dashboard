<!DOCTYPE html>
<html>
<head>
  <title>PDF Upload Dashboard</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <nav class="navbar">
  <a href="dashboard-products.html" class="nav-link" id="nav-products">Products</a>
  <a href="dashboard-pdf.html" class="nav-link" id="nav-pdf">Upload PDF</a>
</nav>
  <div class="container">
    <h2>Upload Purchase Order (PDF)</h2>
    <input type="file" id="pdfInput" accept="application/pdf" />
    <button id="downloadBtn" style="display:none;">Download CSV</button>
    <div id="outputTable"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    document.getElementById('pdfInput').addEventListener('change', async function () {
      const file = this.files[0];
      if (!file) return;

      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      let lines = [];

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const items = content.items.map(item => item.str.trim()).filter(Boolean);
        lines.push(...items);
      }

      // Join into one big string to extract PO number
      const fullText = lines.join(" ");
      const poMatch = fullText.match(/Purchase Order (\d+)/i);
      const poNumber = poMatch ? poMatch[1] : "Unknown";

      // Reconstruct multi-line product blocks
      const blocks = [];
      let buffer = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        if (/^\d{6}\b/.test(line)) {
          if (buffer.length) blocks.push(buffer);
          buffer = [line];
        } else if (/^\d+\s+(Piece|Kilo)/.test(line)) {
          buffer.push(line);
          blocks.push(buffer);
          buffer = [];
        } else {
          buffer.push(line);
        }
      }
      if (buffer.length) blocks.push(buffer);

      // Extract structured data from each block
      const extractedRows = [];

      blocks.forEach(block => {
        const joined = block.join(" ");
        const match = joined.match(/^(\d{6})\s+(.+?)\s+(\d{1,5})\s+(?:Piece|Kilo)/);
        if (match) {
          const productId = match[1];
          const itemName = match[2].replace(/\s{2,}/g, " ");
          const quantity = match[3];

          let vendor = "Unknown";
          if (/kilimohai/i.test(itemName)) vendor = "Kilimohai";
          else if (/sylvia/i.test(itemName)) vendor = "Sylvia Basket";

          extractedRows.push({ productId, itemName, quantity, vendor });
        }
      });

      // Render table
      let html = `<h3>PO Number: ${poNumber}</h3>`;
      html += `<table><thead><tr><th>Product ID</th><th>Item Name</th><th>Quantity</th><th>Vendor</th></tr></thead><tbody>`;
      extractedRows.forEach(row => {
        html += `<tr><td>${row.productId}</td><td>${row.itemName}</td><td>${row.quantity}</td><td>${row.vendor}</td></tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById("outputTable").innerHTML = html;

      // CSV Export
      const downloadBtn = document.getElementById("downloadBtn");
      if (extractedRows.length) {
        downloadBtn.style.display = "inline-block";
        downloadBtn.onclick = () => {
          let csv = `PO Number,${poNumber}\n\nProduct ID,Item Name,Quantity,Vendor\n`;
          extractedRows.forEach(row => {
            csv += `"${row.productId}","${row.itemName}","${row.quantity}","${row.vendor}"\n`;
          });
          const blob = new Blob([csv], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `PO_${poNumber}_Extract.csv`;
          a.click();
          URL.revokeObjectURL(url);
        };
      } else {
        downloadBtn.style.display = "none";
        alert("No product lines found.");
      }
    });
  </script>
</body>
</html>
